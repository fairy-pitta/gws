# ADR-001: プロセス管理方式

## ステータス

Accepted

## コンテキスト

portree は複数の git worktree にまたがる開発サーバーを起動・管理する必要がある。プロセス管理にはいくつかのアプローチがある:

1. **Docker Compose** - コンテナベース、Docker のインストールが必要
2. **直接プロセス起動** - `sh -c` によるネイティブプロセス
3. **systemd/launchd** - OS レベルのサービス管理

ユーザーは通常:
- 既存の開発ツールチェインをそのまま使いたい
- Docker のような追加の依存関係を避けたい
- 手動でコマンドを実行した場合と同じ動作を期待する

Git worktree はホストファイルシステム上で動作するため、コンテナのボリュームマウントは複雑になる。

## 決定

プロセスグループ管理付きの `sh -c` による直接プロセス起動を採用:

```go
cmd := exec.Command("sh", "-c", command)
cmd.SysProcAttr = &syscall.SysProcAttr{Setpgid: true}
```

実装の要点:
- 各サービスはプロセスグループリーダーとして実行
- 子プロセスは `syscall.Kill(-pgid, syscall.SIGTERM)` で終了
- タイムアウト付きの graceful shutdown、その後 SIGKILL
- 孤児プロセス検出用に state.json で PID を追跡

## 結果

### 良い点
- **依存関係ゼロ** - 単一バイナリでインストール
- **ネイティブパフォーマンス** - コンテナのオーバーヘッドなし
- **馴染みのある動作** - 手動実行と全く同じ動作
- **簡単なデバッグ** - 標準ツール（ps, lsof, strace）がそのまま使える

### 悪い点
- **分離なし** - プロセスはホスト環境を共有
- **プラットフォーム差異** - プロセスグループのセマンティクスが異なる（Windows は別実装が必要）
- **孤児プロセス** - portree がクラッシュするとプロセスが残る可能性（PID 追跡で軽減）
